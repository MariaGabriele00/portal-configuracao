<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Softphone - Impulsefy</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --phone-bg: #1e293b;
            --screen-bg: #0f172a;
            --accent-color: #25D366; /* WhatsApp Green */
            --hangup-color: #ef4444;
            --text-color: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .phone-container {
            background-color: var(--phone-bg);
            width: 360px;
            height: 700px;
            border-radius: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 8px solid #334155;
        }

        /* --- Tela de Status --- */
        .screen {
            background-color: var(--screen-bg);
            height: 250px;
            border-radius: 20px;
            margin-bottom: 20px;
            padding: 15px;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
        }

        .header-info {
            font-size: 0.8rem;
            color: #94a3b8;
            display: flex;
            justify-content: space-between;
        }

        .call-status {
            text-align: center;
            margin-top: 20px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            background-color: #334155;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #64748b;
        }

        .status-text {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .call-timer {
            font-family: monospace;
            color: var(--accent-color);
        }

        .log-window {
            font-size: 0.7rem;
            color: #00ff9d;
            font-family: monospace;
            max-height: 60px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            padding: 5px;
            border-radius: 5px;
        }

        /* --- Input de Número --- */
        .number-display {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            text-align: center;
            width: 100%;
            margin-bottom: 20px;
            outline: none;
        }

        /* --- Teclado --- */
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .key {
            background-color: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            width: 65px;
            height: 65px;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background 0.2s;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .key:hover { background-color: rgba(255,255,255,0.2); }
        .key span { font-size: 0.7rem; color: #94a3b8; margin-top: -2px; }

        /* --- Controles de Chamada --- */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: auto;
        }

        .btn-call {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .btn-call:active { transform: scale(0.95); }

        .start-call { background-color: var(--accent-color); box-shadow: 0 0 15px rgba(37, 211, 102, 0.4); }
        .end-call { background-color: var(--hangup-color); box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
        
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div class="phone-container">
        <div class="screen">
            <div class="header-info">
                <span id="companyIdDisplay">Carregando...</span>
                <i class="fab fa-whatsapp"></i>
            </div>
            
            <div class="call-status">
                <div class="avatar"><i class="fas fa-user"></i></div>
                <div class="status-text" id="statusText">Pronto para ligar</div>
                <div class="call-timer" id="timer">00:00</div>
            </div>

            <div class="log-window" id="logWindow">
                > Sistema inicializado...
            </div>
        </div>

        <input type="text" class="number-display" id="phoneNumber" placeholder="Digite o número..." readonly>

        <div class="keypad">
            <button class="key" onclick="pressKey('1')">1<span>&nbsp;</span></button>
            <button class="key" onclick="pressKey('2')">2<span>ABC</span></button>
            <button class="key" onclick="pressKey('3')">3<span>DEF</span></button>
            <button class="key" onclick="pressKey('4')">4<span>GHI</span></button>
            <button class="key" onclick="pressKey('5')">5<span>JKL</span></button>
            <button class="key" onclick="pressKey('6')">6<span>MNO</span></button>
            <button class="key" onclick="pressKey('7')">7<span>PQRS</span></button>
            <button class="key" onclick="pressKey('8')">8<span>TUV</span></button>
            <button class="key" onclick="pressKey('9')">9<span>WXYZ</span></button>
            <button class="key" onclick="pressKey('*')">*</button>
            <button class="key" onclick="pressKey('0')">0<span>+</span></button>
            <button class="key" onclick="pressKey('#')">#</button>
        </div>

        <div class="controls">
            <button id="btnCall" class="btn-call start-call" onclick="startCall()">
                <i class="fas fa-phone"></i>
            </button>
            <button id="btnHangup" class="btn-call end-call hidden" onclick="endCall()">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>

    <script>
        // --- Configuração ---
        const params = new URLSearchParams(window.location.search);
        const accountId = params.get('accountId');
        const urlContactPhone = params.get('contactPhone');
        
        let currentCallId = null;
        let callTimer = null;
        let seconds = 0;
        let isCallActive = false;

        // Inicialização
        document.getElementById('companyIdDisplay').textContent = accountId ? `ID: ${accountId}` : 'Sem Conta';
        if(urlContactPhone) {
            document.getElementById('phoneNumber').value = urlContactPhone;
        }

        // --- Funções de Interface ---
        function log(msg) {
            const logWindow = document.getElementById('logWindow');
            logWindow.innerHTML += `<div>> ${msg}</div>`;
            logWindow.scrollTop = logWindow.scrollHeight;
        }

        function pressKey(key) {
            const input = document.getElementById('phoneNumber');
            input.value += key;
            
            // Se a chamada estiver ativa, envia DTMF
            if (isCallActive && currentCallId) {
                sendDTMF(key);
            }
        }

        function updateStatus(status, color = 'white') {
            const el = document.getElementById('statusText');
            el.textContent = status;
            el.style.color = color;
        }

        function toggleButtons(state) {
            if (state === 'calling') {
                document.getElementById('btnCall').classList.add('hidden');
                document.getElementById('btnHangup').classList.remove('hidden');
                isCallActive = true;
            } else {
                document.getElementById('btnCall').classList.remove('hidden');
                document.getElementById('btnHangup').classList.add('hidden');
                isCallActive = false;
            }
        }

        function startTimer() {
            seconds = 0;
            clearInterval(callTimer);
            callTimer = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer').textContent = `${mins}:${secs}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(callTimer);
            document.getElementById('timer').textContent = "00:00";
        }

        // --- Integração com API ---

        async function startCall() {
            const number = document.getElementById('phoneNumber').value;
            if (!number || !accountId) {
                log("Erro: Número ou Conta faltando.");
                return;
            }

            updateStatus("Chamando...", "#25D366");
            log(`Iniciando chamada para ${number}...`);
            toggleButtons('calling');

            try {
                const response = await fetch('/api/calls/initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to_number: number, accountId: accountId })
                });
                
                const data = await response.json();

                if (response.ok) {
                    currentCallId = data.call_id;
                    log(`Chamada iniciada. ID: ${currentCallId}`);
                    updateStatus("Conectado", "#25D366");
                    startTimer();
                } else {
                    log(`Erro: ${data.error}`);
                    updateStatus("Falha ao ligar", "red");
                    setTimeout(() => toggleButtons('idle'), 2000);
                }
            } catch (error) {
                log("Erro de conexão.");
                toggleButtons('idle');
            }
        }

        async function endCall() {
            if (!currentCallId) return;

            log("Encerrando chamada...");
            try {
                const response = await fetch('/api/calls/terminate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ call_id: currentCallId })
                });
                log("Chamada encerrada.");
            } catch (error) {
                log("Erro ao enviar comando de encerrar.");
            }

            // Limpeza de UI
            stopTimer();
            updateStatus("Encerrado", "red");
            toggleButtons('idle');
            currentCallId = null;
            setTimeout(() => updateStatus("Pronto para ligar", "white"), 2000);
        }

        async function sendDTMF(digit) {
            log(`Enviando tom: ${digit}`);
            try {
                await fetch('/api/calls/sendDTMF', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ call_id: currentCallId, digits: digit })
                });
            } catch (e) {
                log("Falha no DTMF");
            }
        }
    </script>
</body>
</html>
